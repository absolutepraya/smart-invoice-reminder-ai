#!/bin/sh

echo "Running pre-push checks..."

# Frontend: Type check + tests
echo "  Type checking frontend..."
cd apps/web && pnpm typecheck
if [ $? -ne 0 ]; then
  echo "Frontend type check failed."
  exit 1
fi

echo "  Testing frontend..."
pnpm test
if [ $? -ne 0 ]; then
  echo "Frontend tests failed."
  exit 1
fi
cd ../..

# Backend: Type check + tests
echo "  Type checking backend..."
cd apps/api && uv run mypy src/
if [ $? -ne 0 ]; then
  echo "Backend type check failed."
  exit 1
fi

echo "  Testing backend..."
# pytest exits 5 when no tests are collected â€” treat as success
# Use || to prevent set -e from killing the script on non-zero exit
rc=0
uv run pytest || rc=$?
if [ $rc -ne 0 ] && [ $rc -ne 5 ]; then
  echo "Backend tests failed."
  exit 1
fi
cd ../..

echo "Pre-push checks passed!"
